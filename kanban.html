<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ö–∞–Ω–±–∞–Ω –õ–æ–≥–∏—Å—Ç–∏–∫–∏ (09/12)</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600;700&display=swap');

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      margin: 0;
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f2f2f7;
      color: #1c1c1e;
      font-size: 14px;
      line-height: 1.4;
    }

    header {
      padding: 12px 16px;
      background: #007aff;
      color: #ffffff;
      display: flex;
      align-items: center;
      gap: 12px;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    header h1 {
      font-size: 18px;
      margin: 0 12px 0 0;
      font-weight: 600;
      color: #ffffff;
    }

    button {
      padding: 6px 14px;
      border-radius: 10px;
      border: none;
      background: #ffffff;
      color: #007aff;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
      font-size: 13px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    button:hover {
      background: #f2f2f7;
      color: #007aff;
    }

    #search-input {
      flex: 1;
      max-width: 260px;
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      background: #ffffff;
      color: #1c1c1e;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    #board {
      display: flex;
      align-items: flex-start;
      gap: 14px;
      padding: 16px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .column {
      background: #ffffff;
      border-radius: 12px;
      padding: 12px;
      min-width: 280px;
      max-width: 320px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 1px 8px rgba(0, 0, 0, 0.08);
      border: 1px solid #e5e5ea;
      cursor: grab;
    }

    .column-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .column-title {
      font-weight: 600;
      font-size: 15px;
      color: #1c1c1e;
    }

    .column-body {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 50px;
    }

    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.12);
      font-size: 13px;
      cursor: grab;
      transition: 0.2s;
      border-left: 4px solid #007aff;
      position: relative;
    }

    .card.dragging {
      opacity: 0.5;
    }

    .card-row {
      margin-bottom: 4px;
    }

    .card-label {
      font-weight: 600;
      margin-right: 4px;
      color: #3c3c43;
    }

    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      margin-right: 4px;
      cursor: pointer;
    }

    .tag-red {
      background: #ff3b30;
      color: #ffffff;
    }

    .tag-yellow {
      background: #ffcc00;
      color: #000000;
    }

    .tag-green {
      background: #34c759;
      color: #ffffff;
    }

    .tag-done {
      background: #30d158;
      color: #ffffff;
    }

    .small {
      font-size: 12px;
      color: #8e8e93;
    }

    .card-updated {
      font-size: 11px;
      color: #8e8e93;
      font-style: italic;
    }

    .card-updated.stale {
      color: #ff3b30;
      font-weight: 600;
    }

    .notification {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 12px;
      height: 12px;
      background: #ff3b30;
      border-radius: 50%;
      display: none;
    }

    .card.stale .notification {
      display: block;
    }

    .toolbar-right {
      margin-left: auto;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    @media (max-width: 900px) {
      header {
        flex-wrap: wrap;
      }
      .toolbar-right {
        margin-left: 0;
      }
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal-backdrop.show {
      display: flex;
    }

    .modal {
      background: #ffffff;
      border-radius: 12px;
      padding: 20px;
      width: min(480px, 95%);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
      border: 1px solid #e5e5ea;
    }

    .modal h2 {
      margin: 0 0 14px;
      font-size: 18px;
      font-weight: 600;
      color: #1c1c1e;
    }

    .modal-row {
      margin-bottom: 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
    }

    .modal-row label {
      font-weight: 600;
      color: #1c1c1e;
    }

    .modal-row input,
    .modal-row select,
    .modal-row textarea {
      width: 100%;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-family: inherit;
      font-size: 13px;
      resize: vertical;
      background: #ffffff;
      color: #1c1c1e;
    }

    .modal-row input:focus,
    .modal-row select:focus,
    .modal-row textarea:focus {
      outline: 2px solid #007aff;
      border-color: #007aff;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 12px;
    }

    .btn-secondary {
      background: #f2f2f7;
      color: #1c1c1e;
      border: none;
    }

    .btn-danger {
      background: #ff3b30;
      color: #ffffff;
      border: none;
    }
  </style>
</head>
<body>
<header>
  <h1>–ö–∞–Ω–±–∞–Ω –õ–æ–≥–∏—Å—Ç–∏–∫–∏ (09/12)</h1>
  <input id="search-input" type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–∞–º..." />
  <button onclick="clearSearch()">‚úï</button>
  <button onclick="downloadSummary()">–°–≤–æ–¥–∫–∞</button>
  <div class="toolbar-right">
    <button onclick="addColumn()">+ –ö–æ–ª–æ–Ω–∫–∞</button>
    <button onclick="addCardToFirst()">+ –ö–∞—Ä—Ç–æ—á–∫–∞</button>
    <button onclick="saveBoard()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button onclick="loadBoard()">‚ü≥ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    <button onclick="resetToDefault()">‚Ü∫ –°–±—Ä–æ—Å</button>
  </div>
</header>

<div id="board"></div>

<div id="modal-backdrop" class="modal-backdrop">
  <div class="modal">
    <h2>–ö–∞—Ä—Ç–æ—á–∫–∞</h2>
    <div class="modal-row">
      <label>–ó–∞–∫–∞–∑</label>
      <input id="f-order" type="text">
    </div>
    <div class="modal-row">
      <label>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ</label>
      <input id="f-responsible" type="text">
    </div>
    <div class="modal-row">
      <label>–°—Ç–∞—Ç—É—Å (—Å —ç–º–æ–¥–∑–∏)</label>
      <select id="f-status">
        <option value="üî¥">üî¥ –ö—Ä–∞—Å–Ω—ã–π</option>
        <option value="üü°">üü° –ñ–µ–ª—Ç—ã–π</option>
        <option value="üü¢">üü¢ –ó–µ–ª–µ–Ω—ã–π</option>
        <option value="‚úîÔ∏è">‚úîÔ∏è –ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
      </select>
    </div>
    <div class="modal-row">
      <label>–û–ø–ª–∞—Ç–∞ –∑–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç</label>
      <select id="f-transport">
        <option value="üî¥">üî¥ –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ</option>
        <option value="üü¢">üü¢ –û–ø–ª–∞—á–µ–Ω–æ</option>
      </select>
    </div>
    <div class="modal-row">
      <label>PI</label>
      <input id="f-pi" type="text">
    </div>
    <div class="modal-row">
      <label>–î–∞—Ç–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ / ETD</label>
      <input id="f-eta" type="text">
    </div>
    <div class="modal-row">
      <label>–í–µ—Å / –û–±—ä—ë–º</label>
      <input id="f-weight" type="text">
    </div>
    <div class="modal-row">
      <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
      <textarea id="f-comment" rows="3"></textarea>
    </div>
    <div class="modal-row">
      <label>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</label>
      <textarea id="f-extra" rows="2"></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn-danger" onclick="deleteCurrentCard()">–£–¥–∞–ª–∏—Ç—å</button>
      <button class="btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      <button onclick="applyModal()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<script>
  const STORAGE_KEY = 'kanban_kb_lcc_v1';

  function statusClass(status) {
    if (!status) return '';
    if (status.includes('‚úîÔ∏è')) return 'tag-done';
    if (status.includes('üü¢')) return 'tag-green';
    if (status.includes('üü°')) return 'tag-yellow';
    if (status.includes('üî¥')) return 'tag-red';
    return '';
  }

  function formatNowShort() {
    const d = new Date();
    const pad = (n) => String(n).padStart(2, '0');
    return `${pad(d.getDate())}/${pad(d.getMonth() + 1)} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function isStale(dateString) {
    if (!dateString) return false;
    const [dd, mm] = dateString.split(' ')[0].split('/').map(Number);
    if (!dd || !mm) return false;

    const now = new Date();
    const candidate = new Date(now.getFullYear(), mm - 1, dd);
    const yesterday = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
    return candidate.getTime() <= yesterday.getTime();
  }

  function el(tag, attrs={}, ...children){
    const node=document.createElement(tag);
    Object.entries(attrs).forEach(([k,v])=>{
      if(k==='class') node.className=v;
      else if(k==='dataset') Object.assign(node.dataset,v);
      else if(k==='contenteditable') node.setAttribute('contenteditable',v);
      else if(k==='onclick') node.onclick=v;
      else node[k]=v;
    });
    for(const ch of children){
      if(typeof ch==='string') node.appendChild(document.createTextNode(ch));
      else if(ch) node.appendChild(ch);
    }
    return node;
  }

  function renderCard(card){
    const cardEl=el('div',{class:'card',draggable:true,dataset:{id:card.id}});
    if (isStale(card.lastUpdated)) {
      cardEl.classList.add('stale');
    }

    const top=el('div',{class:'card-row'},
      el('span',{class:'card-label'},'–ó–∞–∫–∞–∑: '),
      el('span',{contenteditable:'true'},card.order||'')
    );

    const updatedRow = el('div', { class: 'card-row small' },
      el('span', { class: 'card-label' }, '–ü–æ—Å–ª. –∏–∑–º.: '),
      el('span', { class: 'card-updated' }, card.lastUpdated || '')
    );
    const updatedSpanInRow = updatedRow.querySelector('.card-updated');
    if (card.lastUpdated && isStale(card.lastUpdated)) {
      updatedSpanInRow.classList.add('stale');
    }

    const resp=el('div',{class:'card-row small'},
      el('span',{class:'card-label'},'–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ: '),
      el('span',{contenteditable:'true'},card.responsible||'')
    );

    const statusRow=el('div',{class:'card-row small'});
    const tag=el('span',{class:'tag '+statusClass(card.status)},card.status||'');
    tag.setAttribute('contenteditable','true');
    statusRow.appendChild(el('span',{class:'card-label'},'–°—Ç–∞—Ç—É—Å: '));
    statusRow.appendChild(tag);

    const transportRow=el('div',{class:'card-row small'},
      el('span',{class:'card-label'},'–û–ø–ª–∞—Ç–∞: '),
      el('span',{contenteditable:'true'},card.transport||'üî¥')
    );

    const pi=el('div',{class:'card-row small'},
      el('span',{class:'card-label'},'PI: '),
      el('span',{contenteditable:'true'},card.pi||'-')
    );
    const eta=el('div',{class:'card-row small'},
      el('span',{class:'card-label'},'–ì–æ—Ç–æ–≤–Ω./ETD: '),
      el('span',{contenteditable:'true'},card.eta||'-')
    );
    const weight=el('div',{class:'card-row small'},
      el('span',{class:'card-label'},'–í–µ—Å/–û–±—ä—ë–º: '),
      el('span',{contenteditable:'true'},card.weight||'-')
    );
    const comment=el('div',{class:'card-row small'},
      el('span',{class:'card-label'},'–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: '),
      el('span',{contenteditable:'true'},card.comment||'-')
    );
    const extra=el('div',{class:'card-row small'},
      el('span',{class:'card-label'},'–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: '),
      el('span',{contenteditable:'true'},card.extra||'-')
    );

    const notification = el('div', { class: 'notification' });
    cardEl.appendChild(notification);

    cardEl.append(top, updatedRow, resp, statusRow, transportRow, pi, eta, weight, comment, extra);

    cardEl.addEventListener('dragstart',(e)=>{
      cardEl.classList.add('dragging');
      e.dataTransfer.setData('text/plain','dragging');
    });
    cardEl.addEventListener('dragend',()=>{
      cardEl.classList.remove('dragging');
      saveBoard();
    });
    cardEl.addEventListener('click',(e)=>{
      if(e.target.tagName==='BUTTON') return;
      openModalForCard(cardEl);
    });

    return cardEl;
  }

  function renderColumn(column){
    const colEl=el('div',{class:'column',draggable:true,dataset:{id:column.id}});
    const title=el('div',{class:'column-title',contenteditable:'true'},column.title||'–ù–æ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞');
    const addBtn=el('button',{onclick:()=>addCard(colEl)},'+ –ö–∞—Ä—Ç–æ—á–∫–∞');
    const header=el('div',{class:'column-header'},title,addBtn);
    const body=el('div',{class:'column-body'});

    body.addEventListener('dragover',(e)=>{e.preventDefault(); body.classList.add('drop-hover');});
    body.addEventListener('dragleave',()=>{body.classList.remove('drop-hover');});
    body.addEventListener('drop',(e)=>{
      e.preventDefault();
      const dragging=document.querySelector('.card.dragging');
      if(dragging) {
        const fromColumn = dragging.closest('.column');
        const fromId = fromColumn.dataset.id;
        const toId = colEl.dataset.id;

        // –ï—Å–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∞ –∏–∑ "–ó–∞–≤–µ—Ä—à–µ–Ω–æ" ‚Äî –Ω–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞—Ç—å –æ–±—Ä–∞—Ç–Ω–æ
        if (fromId === 'col-done' && toId !== 'col-done') return;

        // –ï—Å–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∞ –≤ "–ó–∞–≤–µ—Ä—à–µ–Ω–æ" ‚Äî –ø—Ä–æ—Å—Ç–∞–≤–∏—Ç—å –¥–∞—Ç—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        if (toId === 'col-done' && fromId !== 'col-done') {
          const updatedSpan = dragging.querySelector('.card-updated');
          if (updatedSpan) {
            updatedSpan.textContent = formatNowShort();
            updatedSpan.classList.remove('stale');
          }
        }

        body.appendChild(dragging);
      }
      body.classList.remove('drop-hover');
      saveBoard();
    });

    colEl.addEventListener('dragstart', (e) => {
      colEl.classList.add('dragging');
      e.dataTransfer.setData('text/plain', column.id);
    });

    colEl.addEventListener('dragend', () => {
      colEl.classList.remove('dragging');
      saveBoard();
    });

    (column.cards||[]).forEach(c=>body.appendChild(renderCard(c)));
    colEl.append(header,body);
    return colEl;
  }

  function renderBoard(data){
    const board=document.getElementById('board');
    board.innerHTML='';
    data.columns.forEach(col=>board.appendChild(renderColumn(col)));
    applySearchFilter();
  }

  async function loadBoard(){
    const stored = localStorage.getItem(STORAGE_KEY);
    const data = stored ? JSON.parse(stored) : defaultData;
    renderBoard(data);
  }

  function saveBoard() {
    const boardEl = document.getElementById('board');
    const colsEls = Array.from(boardEl.querySelectorAll('.column'));

    const data = {
      columns: colsEls.map(colEl => {
        const colId = colEl.dataset.id;
        const title = colEl.querySelector('.column-title').textContent.trim();
        const cardsEls = Array.from(colEl.querySelectorAll('.card'));

        const cards = cardsEls.map(cardEl => {
          const getField = (label) => {
            const row = Array.from(cardEl.querySelectorAll('.card-row'))
              .find(r => r.querySelector('.card-label')?.textContent.startsWith(label));
            if (!row) return '';
            const span = row.querySelector('span[contenteditable="true"]') || row.querySelector('.tag') || row.querySelector('.card-updated');
            return span ? span.textContent.trim() : '';
          };
          return {
            id: cardEl.dataset.id,
            order: getField('–ó–∞–∫–∞–∑'),
            responsible: getField('–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ'),
            status: getField('–°—Ç–∞—Ç—É—Å'),
            transport: getField('–û–ø–ª–∞—Ç–∞'),
            pi: getField('PI'),
            eta: getField('–ì–æ—Ç–æ–≤–Ω./ETD'),
            weight: getField('–í–µ—Å/–û–±—ä—ë–º'),
            comment: getField('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π'),
            extra: getField('–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ'),
            lastUpdated: getField('–ü–æ—Å–ª. –∏–∑–º.')
          };
        });

        return { id: colId, title, cards };
      })
    };

    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  function resetToDefault(){
    if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –∫ –∏—Å—Ö–æ–¥–Ω—ã–º –¥–∞–Ω–Ω—ã–º?')){
      renderBoard(defaultData);
      localStorage.removeItem(STORAGE_KEY);
    }
  }

  const defaultData = {
    "columns":[
      {"id":"col-plan","title":"–ü–ª–∞–Ω–∏—Ä—É–µ–º / –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å / –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ","cards":[
        {"id":"c977","order":"977","responsible":"–†–∏—Ç–∞ / –°–∞—à–∞ / –ò—Å–º–∞–∏–ª","status":"üî¥","transport":"üî¥","pi":"-","eta":"-","weight":"-","comment":"–£—Ç–æ—á–Ω—è–µ–º —Å —Ç—Ä–µ–º—è –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º–∏ –ø–æ –ø–æ–∫—É–ø–∫–µ —á–µ—Ä–µ–∑ –¢–î, –ø–æ—Ç–æ–º –º–æ–∂–Ω–æ —Å–±–æ—Ä–∫—É","extra":"-","lastUpdated":"09/12 16:53"},
        {"id":"c863_931","order":"863 + 931","responsible":"–Æ–ª—è / Ismail","status":"üî¥","transport":"üî¥","pi":"250912, 251031","eta":"09/12/25","weight":"11‚ÄØ524 –∫–≥ / 27 –º¬≥","comment":"–í–∞—Ä–∏–∞–Ω—Ç —Å 40HQ –ø–æ –ø—Ä—è–º–æ–º—É –ñ–î; –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–∏–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —Å –¥—Ä—É–≥–∏–º–∏ –∑–∞–∫–∞–∑–∞–º–∏","extra":"–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ 40HQ: 26‚ÄØ—Ç –±—Ä—É—Ç—Ç–æ, 66 –º¬≥","lastUpdated":"09/12 16:53"},
        {"id":"c920","order":"920","responsible":"–Æ–ª—è / Elsa","status":"üî¥","transport":"üî¥","pi":"251022","eta":"09/12/25","weight":"-","comment":"–ì—Ä—É–∑ –æ–∂–∏–¥–∞–µ—Ç—Å—è –∫ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ 09/12; –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –ø—Ä–æ–≤–µ—Ä–∏–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —Å 863 + 931","extra":"-","lastUpdated":"09/12 16:53"},
        {"id":"c930_964_965","order":"930 + 964 + 965","responsible":"–Æ–ª—è / Elsa","status":"üî¥","transport":"üî¥","pi":"251028, 251126-25, 251126-2","eta":"-","weight":"-","comment":"–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ PET paper foil, –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî –≤—Å—ë, —á—Ç–æ –ø–æ–º–µ—â–∞–µ—Ç—Å—è; –æ—Å—Ç–∞—Ç–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω LCL. –ñ–¥—ë–º —É—Ç–æ—á–Ω–µ–Ω–∏—è –¥–∞—Ç—ã –∑–∞–±–æ—Ä–∞ –∏ –∑–∞—Ç–∞—Ä–∫–∏","extra":"-","lastUpdated":"09/12 16:53"},
        {"id":"c949","order":"949","responsible":"–°–∞—à–∞ / Elsa","status":"üü°","transport":"üî¥","pi":"-","eta":"09/12","weight":"-","comment":"–ù–∞ —Å–∫–ª–∞–¥–µ –∞–≥–µ–Ω—Ç–∞; –∂–¥—ë–º –ø—Ä–∏–±—ã—Ç–∏—è –≥—Ä—É–∑–∞ –≤ –ú–∞–Ω—å—á–∂—É—Ä–∏—é 12/12 –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö","extra":"–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –≤—ã—Ö–æ–¥ 09/12","lastUpdated":"09/12 16:52"}
      ]},
      {"id":"col-border","title":"–î–æ –≥—Ä–∞–Ω–∏—Ü—ã / –ù–∞ –≤—ã—Ö–æ–¥","cards":[
        {"id":"c946","order":"946","responsible":"Peter / –ù–∞—Å—Ç—è","status":"üü°","transport":"üî¥","pi":"-","eta":"06/12","weight":"-","comment":"–í –ø—É—Ç–∏ –∫ –≥—Ä–∞–Ω–∏—Ü–µ –ö–∏—Ç–∞—è; –¥–æ –≥—Ä–∞–Ω–∏—Ü—ã ~812 –∫–º; –∂–¥—ë–º —Å–ª–µ–¥—É—é—â–µ–π —Ç–æ—á–∫–∏ –¥–≤–∏–∂–µ–Ω–∏—è","extra":"-","lastUpdated":"09/12 16:52"},
        {"id":"c962","order":"962","responsible":"–Æ–ª—è / Lucky","status":"üü¢","transport":"üî¥","pi":"-","eta":"17‚Äì19/12","weight":"-","comment":"Location: Manzhouli, CN (in queue to leave China)","extra":"-","lastUpdated":"09/12 16:52"},
        {"id":"c883","order":"883","responsible":"–°–∞—à–∞ / Khasan","status":"üü°","transport":"üî¥","pi":"-","eta":"09/12","weight":"-","comment":"–ü–µ—Ä–µ–º–µ—â—ë–Ω –Ω–∞ –¥—Ä—É–≥—É—é —Å—Ç–∞–Ω—Ü–∏—é; –æ–∂–∏–¥–∞–µ–º –ø—Ä–∏–±—ã—Ç–∏—è –Ω–∞ –≤—ã–≥—Ä—É–∑–∫—É 03‚Äì10/01/26","extra":"-","lastUpdated":"09/12 16:52"}
      ]},
      {"id":"col-customs","title":"–¢–∞–º–æ–∂–Ω—è / –í—ã–¥–∞—á–∞ / –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è","cards":[
        {"id":"c924_932","order":"924 + 932","responsible":"Peter / –ù–∞—Å—Ç—è","status":"üü°","transport":"üî¥","pi":"-","eta":"-","weight":"-","comment":"–û–±–∞ –≥—Ä—É–∑–∞ –º–æ–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å –æ—Ñ–æ—Ä–º–ª—è—Ç—å. –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω—ã. –¢—Ä–∏ –¥–Ω—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ —Å —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ","extra":"-","lastUpdated":"09/12 16:51"}
      ]},
      {"id":"col-done","title":"–ó–∞–≤–µ—Ä—à–µ–Ω–æ","cards":[
        {"id":"c884","order":"884","responsible":"Lotty / –°–∞—à–∞","status":"‚úîÔ∏è","transport":"üü¢","pi":"-","eta":"-","weight":"-","comment":"-","extra":"-","lastUpdated":"09/12 16:51"},
        {"id":"c919","order":"919","responsible":"Tess / –ù–∞—Å—Ç—è","status":"‚úîÔ∏è","transport":"üü¢","pi":"-","eta":"-","weight":"-","comment":"-","extra":"-","lastUpdated":"09/12 16:51"},
        {"id":"c890","order":"890","responsible":"Haya / –Æ–ª—è","status":"‚úîÔ∏è","transport":"üü¢","pi":"-","eta":"-","weight":"-","comment":"–ó–∞–≤–µ—Ä—à–µ–Ω–æ","extra":"-","lastUpdated":"09/12 16:51"}
      ]}
    ]
  };

  let currentModalCardEl = null;

  function openModalForCard(cardEl){
    currentModalCardEl=cardEl;
    const getField = (label) => {
      const row = Array.from(cardEl.querySelectorAll('.card-row'))
        .find(r=>r.querySelector('.card-label')?.textContent.startsWith(label));
      if(!row) return '';
      const s=row.querySelector('span[contenteditable="true"]') || row.querySelector('.tag') || row.querySelector('.card-updated');
      return s?s.textContent.trim():'';
    };
    document.getElementById('f-order').value=getField('–ó–∞–∫–∞–∑');
    document.getElementById('f-responsible').value=getField('–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ');
    document.getElementById('f-status').value=getField('–°—Ç–∞—Ç—É—Å');
    document.getElementById('f-transport').value=getField('–û–ø–ª–∞—Ç–∞')||'üî¥';
    document.getElementById('f-pi').value=getField('PI');
    document.getElementById('f-eta').value=getField('–ì–æ—Ç–æ–≤–Ω./ETD');
    document.getElementById('f-weight').value=getField('–í–µ—Å/–û–±—ä—ë–º');
    document.getElementById('f-comment').value=getField('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π');
    document.getElementById('f-extra').value=getField('–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ');
    document.getElementById('modal-backdrop').classList.add('show');
  }

  function closeModal(){
    currentModalCardEl=null;
    document.getElementById('modal-backdrop').classList.remove('show');
  }

  function applyModal(){
    if(!currentModalCardEl) return;
    const setField=(label,value)=>{
      const row=Array.from(currentModalCardEl.querySelectorAll('.card-row'))
        .find(r=>r.querySelector('.card-label')?.textContent.startsWith(label));
      if(!row) return;
      const span=row.querySelector('span[contenteditable="true"]')||row.querySelector('.tag');
      if(!span) return;
      span.textContent=value;
      if(label==='–°—Ç–∞—Ç—É—Å') span.className='tag '+statusClass(value);
      if(label==='–û–ø–ª–∞—Ç–∞') span.className='tag '+statusClass(value);
    };
    setField('–ó–∞–∫–∞–∑',document.getElementById('f-order').value);
    setField('–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ',document.getElementById('f-responsible').value);
    setField('–°—Ç–∞—Ç—É—Å',document.getElementById('f-status').value);
    setField('–û–ø–ª–∞—Ç–∞',document.getElementById('f-transport').value);
    setField('PI',document.getElementById('f-pi').value);
    setField('–ì–æ—Ç–æ–≤–Ω./ETD',document.getElementById('f-eta').value);
    setField('–í–µ—Å/–û–±—ä—ë–º',document.getElementById('f-weight').value);
    setField('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π',document.getElementById('f-comment').value);
    setField('–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ',document.getElementById('f-extra').value);

    const updatedSpan = currentModalCardEl.querySelector('.card-updated');
    if (updatedSpan) {
      const ts = formatNowShort();
      updatedSpan.textContent = ts;
      updatedSpan.classList.remove('stale');
      currentModalCardEl.classList.remove('stale');
      if (isStale(ts)) {
        updatedSpan.classList.add('stale');
        currentModalCardEl.classList.add('stale');
      }
    }

    closeModal();
    saveBoard();
  }

  function deleteCurrentCard(){
    if(currentModalCardEl){
      currentModalCardEl.remove();
      closeModal();
      saveBoard();
    }
  }

  function addColumn(){
    const id='col-'+Date.now();
    const col={id:id,title:'–ù–æ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞',cards:[]};
    defaultData.columns.push(col);
    renderBoard(defaultData);
    saveBoard();
  }

  function addCard(colEl){
    const colId=colEl.dataset.id;
    const col=defaultData.columns.find(c=>c.id===colId);
    const card={id:'c'+Date.now(),order:'',responsible:'',status:'üî¥',transport:'üî¥',pi:'-',eta:'-',weight:'-',comment:'-',extra:'-',lastUpdated:''};
    col.cards.push(card);
    colEl.querySelector('.column-body').appendChild(renderCard(card));
    saveBoard();
  }

  function addCardToFirst(){
    if(defaultData.columns.length>0) addCard(document.querySelector('.column'));
  }

  function applySearchFilter() {
    const input = document.getElementById('search-input');
    const q = (input ? input.value : '').trim().toLowerCase();
    const cards = document.querySelectorAll('.card');

    cards.forEach(card => {
      if (!q) {
        card.style.display = '';
        return;
      }
      const text = card.innerText.toLowerCase();
      if (text.includes(q)) {
        card.style.display = '';
      } else {
        card.style.display = 'none';
      }
    });
  }

  function clearSearch() {
    const input = document.getElementById('search-input');
    if (!input) return;
    input.value = '';
    applySearchFilter();
  }

  function downloadSummary() {
    const input = document.getElementById('search-input');
    const query = (input ? input.value : '').trim();
    const cards = Array.from(document.querySelectorAll('.card'))
      .filter(c => c.style.display !== 'none');

    if (cards.length === 0) {
      alert('–ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è —Å–≤–æ–¥–∫–∏ (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∏–ª—å—Ç—Ä).');
      return;
    }

    const lines = [];
    if (query) {
      lines.push(`–°–≤–æ–¥–∫–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É: "${query}"`);
    } else {
      lines.push('–°–≤–æ–¥–∫–∞ –ø–æ –≤—Å–µ–º –∫–∞—Ä—Ç–æ—á–∫–∞–º');
    }
    lines.push('');

    cards.forEach(card => {
      const getField = (label) => {
        const row = Array.from(card.querySelectorAll('.card-row'))
          .find(r => r.querySelector('.card-label')?.textContent.startsWith(label));
        if (!row) return '';
        const span = row.querySelector('span[contenteditable="true"]') || row.querySelector('.tag') || row.querySelector('.card-updated');
        return span ? span.textContent.trim() : '';
      };
      const order = getField('–ó–∞–∫–∞–∑');
      const resp = getField('–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ');
      const comment = getField('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π');
      const lastUpd = getField('–ü–æ—Å–ª. –∏–∑–º.');

      lines.push(`–ó–∞–∫–∞–∑: ${order}`);
      lines.push(`–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ: ${resp}`);
      lines.push(`–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${comment}`);
      lines.push(`–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${lastUpd}`);
      lines.push('');
    });

    const text = lines.join('\n');
    const blob = new Blob([text], {type: 'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const fileName = query ? `svodka_${query}.txt` : 'svodka_kanban.txt';
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  document.addEventListener('DOMContentLoaded',()=>{
    loadBoard();
    const input = document.getElementById('search-input');
    if (input) {
      input.addEventListener('input', applySearchFilter);
    }
  });
  document.getElementById('modal-backdrop').addEventListener('click', e=>{
    if(e.target.id==='modal-backdrop') closeModal();
  });
</script>
</body>
</html>
